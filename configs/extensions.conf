; =============================================================================
; Asterisk Dialplan Configuration
; =============================================================================
; This dialplan handles incoming calls from SIP provider and routes them
; through n8n for AI processing and TTS response
; =============================================================================

; -----------------------------------------------------------------------------
; INCOMING CALLS FROM SIP PROVIDER
; -----------------------------------------------------------------------------
[from-sip-provider]
; Handle all incoming DID numbers
exten => _X.,1,NoOp(Incoming call from ${CALLERID(num)} to ${EXTEN})
 same => n,Answer()
 same => n,Wait(1)
 ; Play initial greeting
 same => n,Playback(custom/welcome)
 ; Execute AGI script to bridge with n8n
 same => n,AGI(/var/lib/asterisk/agi-bin/agi-connector.sh)
 ; After AGI returns, check if we have a response file
 same => n,GotoIf($[${STAT(e,/var/lib/asterisk/sounds/custom/response_${UNIQUEID}.wav)}]?playresponse:noresponse)
 same => n(playresponse),Playback(custom/response_${UNIQUEID})
 same => n,System(rm -f /var/lib/asterisk/sounds/custom/response_${UNIQUEID}.wav)
 same => n,Goto(goodbye)
 same => n(noresponse),Playback(custom/sorry)
 same => n(goodbye),Playback(custom/goodbye)
 same => n,Hangup()

; Catch-all for unhandled extensions
exten => i,1,NoOp(Invalid extension)
 same => n,Playback(invalid)
 same => n,Hangup()

; Hangup handler
exten => h,1,NoOp(Call ended: ${CDR(duration)} seconds)

; -----------------------------------------------------------------------------
; INTERNAL EXTENSIONS (for testing)
; -----------------------------------------------------------------------------
[internal]
; Test extension - echo test
exten => 100,1,NoOp(Echo Test)
 same => n,Answer()
 same => n,Playback(demo-echotest)
 same => n,Echo()
 same => n,Hangup()

; Test extension - TTS test
exten => 200,1,NoOp(TTS Test)
 same => n,Answer()
 same => n,AGI(/var/lib/asterisk/agi-bin/tts-test.sh)
 same => n,Playback(custom/tts_test)
 same => n,Hangup()

; Test extension - n8n webhook test
exten => 300,1,NoOp(n8n Webhook Test)
 same => n,Answer()
 same => n,AGI(/var/lib/asterisk/agi-bin/agi-connector.sh)
 same => n,Hangup()

; -----------------------------------------------------------------------------
; OUTBOUND CONTEXT (if needed for outgoing calls)
; -----------------------------------------------------------------------------
[outbound]
; Route outbound calls through SIP trunk
; Twilio requires valid Caller ID (purchased number or verified)
exten => _1NXXNXXXXXX,1,NoOp(Outbound call to ${EXTEN})
 same => n,Set(CALLERID(num)=+17756187988)
 same => n,Set(CALLERID(name)=Asterisk PBX)
 same => n,Dial(PJSIP/${EXTEN}@twilio-endpoint,30,r)
 same => n,Hangup()

; International calls (E.164 format)
exten => _+X.,1,NoOp(International call to ${EXTEN})
 same => n,Set(CALLERID(num)=+17756187988)
 same => n,Set(CALLERID(name)=Asterisk PBX)
 same => n,Dial(PJSIP/${EXTEN}@twilio-endpoint,30,r)
 same => n,Hangup()

; -----------------------------------------------------------------------------
; API TRIGGERED CONTEXTS
; -----------------------------------------------------------------------------
[outbound-ai-test]
exten => s,1,Answer()
 same => n,Wait(1)
 same => n,Playback(demo-congrats)
 same => n,Hangup()

; -----------------------------------------------------------------------------
; REAL-TIME CONVERSATIONAL CONTEXT
; -----------------------------------------------------------------------------
[outbound-ai-conversational]
exten => s,1,Answer()
 same => n,Wait(1)
 ; Step 1: Get Initial Greeting from n8n (optional, or just play local welcome)
 same => n,AGI(agi-connector.sh,welcome)
 same => n,ExecIf($["${AGI_STATUS}" = "SUCCESS"]?Playback(${SOUND_FILE}))
 
 ; LOOP START: Conversation
 same => n(record_loop),NoOp(--- Starting Recording Loop ---)
 
 ; Generate unique filename for this turn
 same => n,Set(REC_FILE=/var/lib/asterisk/sounds/custom/rec-${UNIQUEID}-${EPOCH})
 
 ; Record: filename, silence-detect(1s for fast response), max-dur(8s)
 same => n,Record(${REC_FILE}.wav,1,8)
 
 ; Check if recording exists/is valid (Record app moves to next prio on silence/hash)
 same => n,NoOp(Input Recorded: ${REC_FILE}.wav)
 
 ; Send Recording to n8n via AGI
 same => n,AGI(agi-connector.sh,process_input,${REC_FILE}.wav)
 
 ; Play Response if SUCCESS
 same => n,ExecIf($["${AGI_STATUS}" = "SUCCESS"]?Playback(${SOUND_FILE}))
 
 ; If AGI returned HANGUP or error, exit
 same => n,GotoIf($["${AGI_STATUS}" = "HANGUP"]?hangup)
 
 ; Loop back to record again
 same => n,Goto(record_loop)

 same => n(hangup),AGI(agi-connector.sh,hangup)
 same => n,Hangup()

; Hangup handler - called when call ends for any reason
exten => h,1,NoOp(Call ended - sending callback)
 same => n,AGI(agi-connector.sh,hangup)

